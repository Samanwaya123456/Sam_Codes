import React, { useState, useRef, useEffect } from 'react';
import { Upload, MessageSquare, TrendingUp, AlertCircle, Check, Loader, Download, BarChart3, Package } from 'lucide-react';

// E-commerce Analytics Intelligence App
// Built specifically for Indian e-commerce domain with RTO risk analysis, seller performance monitoring, and operational insights

const EcommerceAnalyticsApp = () => {
  const [dataset, setDataset] = useState(null);
  const [dataPreview, setDataPreview] = useState(null);
  const [conversation, setConversation] = useState([]);
  const [userInput, setUserInput] = useState('');
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [analysisResults, setAnalysisResults] = useState(null);
  const [activeTab, setActiveTab] = useState('upload');
  const chatEndRef = useRef(null);

  // Domain knowledge: E-commerce metrics and thresholds
  const DOMAIN_KNOWLEDGE = {
    rtd_threshold: 90, // Ready to Dispatch SLA
    procurement_threshold: 90, // Procurement rate during peak
    rto_high_risk: 30, // RTO percentage considered high risk
    reverse_logistics_premium: 0.10, // 8-12% avg, using 10%
    gold_tier_gmv: 2500000, // Rs. 25 lakhs
    healthy_ltv_cac_ratio: 3.0,
    fashion_avg_return_rate: 35 // Average return rate for fashion
  };

  useEffect(() => {
    chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [conversation]);

  // Parse CSV file
  const parseCSV = (text) => {
    const lines = text.trim().split('\n');
    const headers = lines[0].split(',').map(h => h.trim());
    const rows = lines.slice(1).map(line => {
      const values = line.split(',').map(v => v.trim());
      return headers.reduce((obj, header, index) => {
        obj[header] = values[index];
        return obj;
      }, {});
    });
    return { headers, rows };
  };

  // Handle file upload
  const handleFileUpload = (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const text = e.target.result;
        const parsed = parseCSV(text);
        setDataset(parsed);
        setDataPreview(parsed.rows.slice(0, 5));
        
        // Automatically start context interview
        setActiveTab('analysis');
        initiateContextInterview(parsed);
      };
      reader.readAsText(file);
    }
  };

  // Intelligent context acquisition interview
  const initiateContextInterview = (data) => {
    const headers = data.headers.map(h => h.toLowerCase());
    
    // Analyze dataset structure to infer domain
    let inferredContext = "general e-commerce data";
    let suggestedAnalyses = [];

    // Check for RTO/returns analysis indicators
    if (headers.some(h => h.includes('return') || h.includes('rto'))) {
      inferredContext = "return/RTO data";
      suggestedAnalyses.push("RTO Risk Analysis", "Reverse Logistics Cost Impact");
    }

    // Check for seller performance indicators
    if (headers.some(h => h.includes('seller') || h.includes('rtd') || h.includes('dispatch'))) {
      inferredContext = "seller performance data";
      suggestedAnalyses.push("RTD SLA Compliance", "Seller Tier Analysis");
    }

    // Check for order/transaction data
    if (headers.some(h => h.includes('order') || h.includes('transaction'))) {
      inferredContext = "transaction data";
      suggestedAnalyses.push("Order Volume Trends", "GMV Analysis");
    }

    const contextMessage = {
      type: 'assistant',
      content: `I've analyzed your dataset and detected it appears to be ${inferredContext}. I can see columns: ${headers.slice(0, 6).join(', ')}${headers.length > 6 ? '...' : ''}.

Based on the Indian e-commerce domain context, I can help you with:
${suggestedAnalyses.map((a, i) => `${i + 1}. ${a}`).join('\n')}

What specific question or decision are you trying to address with this data?`,
      timestamp: new Date()
    };

    setConversation([contextMessage]);
  };

  // Send message and trigger AI analysis
  const handleSendMessage = async () => {
    if (!userInput.trim() || !dataset) return;

    const userMessage = {
      type: 'user',
      content: userInput,
      timestamp: new Date()
    };

    setConversation(prev => [...prev, userMessage]);
    setUserInput('');
    setIsAnalyzing(true);

    // Call Claude API for analytical reasoning
    await performIntelligentAnalysis(userInput);
  };

  // AI-powered analysis using Claude API
  const performIntelligentAnalysis = async (userQuery) => {
    try {
      // Prepare dataset summary for Claude
      const datasetSummary = {
        columns: dataset.headers,
        rowCount: dataset.rows.length,
        sampleRows: dataset.rows.slice(0, 3)
      };

      // System prompt with domain expertise
      const systemPrompt = `You are an expert data analyst specializing in Indian e-commerce operations. You understand:
- Seller SLAs (RTD ≥90%, Procurement ≥90% during peak)
- Logistics metrics (RTO rates, reverse logistics costs)
- Performance tiers (Gold requires Rs. 25 lakh GMV)
- Key metrics (AOV, CAC, LTV:CAC ratio of 3:1)

Analyze the user's question in context of their dataset and provide:
1. The specific analytical approach needed
2. Relevant domain insights
3. Actionable recommendations based on thresholds

Dataset summary: ${JSON.stringify(datasetSummary)}

User's question: ${userQuery}

Respond with a JSON object containing:
{
  "analysis_type": "type of analysis",
  "approach": "explanation of analytical approach",
  "key_findings": ["finding 1", "finding 2"],
  "recommendations": ["rec 1", "rec 2"],
  "thresholds_referenced": ["relevant thresholds"]
}`;

      const response = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 1000,
          messages: [
            { role: "user", content: systemPrompt }
          ],
        })
      });

      const data = await response.json();
      const analysisResponse = data.content[0].text;

      // Parse JSON response
      let analysisData;
      try {
        // Extract JSON from markdown if present
        const jsonMatch = analysisResponse.match(/\{[\s\S]*\}/);
        analysisData = JSON.parse(jsonMatch ? jsonMatch[0] : analysisResponse);
      } catch {
        analysisData = {
          analysis_type: "General Analysis",
          approach: analysisResponse,
          key_findings: ["Analysis completed"],
          recommendations: ["Review the detailed findings"],
          thresholds_referenced: []
        };
      }

      // Perform actual data analysis based on the analytical approach
      const computedResults = performDataAnalysis(dataset, analysisData.analysis_type);

      const assistantMessage = {
        type: 'assistant',
        content: generateAnalysisNarrative(analysisData, computedResults),
        analysisData: analysisData,
        computedResults: computedResults,
        timestamp: new Date()
      };

      setConversation(prev => [...prev, assistantMessage]);
      setAnalysisResults(computedResults);
      
    } catch (error) {
      const errorMessage = {
        type: 'assistant',
        content: `I encountered an error during analysis: ${error.message}. Let me try a different approach based on your data structure.`,
        timestamp: new Date()
      };
      setConversation(prev => [...prev, errorMessage]);
      
      // Fallback analysis
      const fallbackResults = performDataAnalysis(dataset, 'exploratory');
      setAnalysisResults(fallbackResults);
    } finally {
      setIsAnalyzing(false);
    }
  };

  // Perform actual statistical analysis on the dataset
  const performDataAnalysis = (data, analysisType) => {
    const results = {
      type: analysisType,
      metrics: {},
      segments: [],
      visualizations: []
    };

    // Detect numeric columns
    const numericColumns = data.headers.filter(header => {
      const firstValue = data.rows[0][header];
      return !isNaN(parseFloat(firstValue));
    });

    // Basic descriptive statistics
    numericColumns.forEach(column => {
      const values = data.rows.map(row => parseFloat(row[column])).filter(v => !isNaN(v));
      if (values.length > 0) {
        results.metrics[column] = {
          mean: values.reduce((a, b) => a + b, 0) / values.length,
          min: Math.min(...values),
          max: Math.max(...values),
          count: values.length
        };
      }
    });

    // RTO-specific analysis if relevant columns exist
    const headers = data.headers.map(h => h.toLowerCase());
    if (headers.some(h => h.includes('return') || h.includes('rto'))) {
      results.rtoAnalysis = analyzeRTO(data);
    }

    // Seller performance analysis
    if (headers.some(h => h.includes('seller') || h.includes('rtd'))) {
      results.sellerAnalysis = analyzeSellerPerformance(data);
    }

    return results;
  };

  // RTO Risk Analysis
  const analyzeRTO = (data) => {
    const headers = data.headers.map(h => h.toLowerCase());
    const returnCol = headers.find(h => h.includes('return'));
    const pincodeCol = headers.find(h => h.includes('pincode'));
    
    if (!returnCol || !pincodeCol) return null;

    // Group by pincode
    const pincodeReturns = {};
    data.rows.forEach(row => {
      const pincode = row[data.headers[headers.indexOf(pincodeCol)]];
      const returnStatus = row[data.headers[headers.indexOf(returnCol)]];
      
      if (!pincodeReturns[pincode]) {
        pincodeReturns[pincode] = { total: 0, returns: 0 };
      }
      pincodeReturns[pincode].total++;
      if (returnStatus && returnStatus.toLowerCase().includes('return')) {
        pincodeReturns[pincode].returns++;
      }
    });

    // Calculate RTO rates
    const rtoData = Object.entries(pincodeReturns).map(([pincode, counts]) => ({
      pincode,
      rtoRate: (counts.returns / counts.total) * 100,
      orderCount: counts.total,
      returnCount: counts.returns
    })).sort((a, b) => b.rtoRate - a.rtoRate);

    const highRiskPincodes = rtoData.filter(p => p.rtoRate > DOMAIN_KNOWLEDGE.rto_high_risk);

    return {
      overallRTORate: (rtoData.reduce((sum, p) => sum + p.returnCount, 0) / 
                       rtoData.reduce((sum, p) => sum + p.orderCount, 0)) * 100,
      highRiskPincodes,
      topPincodes: rtoData.slice(0, 10)
    };
  };

  // Seller Performance Analysis
  const analyzeSellerPerformance = (data) => {
    const headers = data.headers.map(h => h.toLowerCase());
    const sellerCol = headers.find(h => h.includes('seller'));
    const rtdCol = headers.find(h => h.includes('rtd'));
    
    if (!sellerCol) return null;

    const sellerMetrics = {};
    data.rows.forEach(row => {
      const seller = row[data.headers[headers.indexOf(sellerCol)]];
      if (!sellerMetrics[seller]) {
        sellerMetrics[seller] = { totalOrders: 0, onTimeDispatches: 0 };
      }
      sellerMetrics[seller].totalOrders++;
      
      if (rtdCol) {
        const rtdValue = parseFloat(row[data.headers[headers.indexOf(rtdCol)]]);
        if (!isNaN(rtdValue) && rtdValue >= DOMAIN_KNOWLEDGE.rtd_threshold) {
          sellerMetrics[seller].onTimeDispatches++;
        }
      }
    });

    const sellerPerformance = Object.entries(sellerMetrics).map(([seller, metrics]) => ({
      seller,
      rtdCompliance: (metrics.onTimeDispatches / metrics.totalOrders) * 100,
      totalOrders: metrics.totalOrders,
      status: (metrics.onTimeDispatches / metrics.totalOrders) * 100 >= DOMAIN_KNOWLEDGE.rtd_threshold ? 'Gold' : 'At Risk'
    })).sort((a, b) => a.rtdCompliance - b.rtdCompliance);

    return {
      sellers: sellerPerformance,
      atRiskCount: sellerPerformance.filter(s => s.status === 'At Risk').length
    };
  };

  // Generate narrative from analysis
  const generateAnalysisNarrative = (aiAnalysis, computedResults) => {
    let narrative = `**${aiAnalysis.analysis_type}**\n\n`;
    narrative += `${aiAnalysis.approach}\n\n`;

    if (computedResults.rtoAnalysis) {
      const rto = computedResults.rtoAnalysis;
      narrative += `**RTO Analysis Findings:**\n`;
      narrative += `• Overall RTO Rate: ${rto.overallRTORate.toFixed(1)}%\n`;
      narrative += `• High-Risk Pincodes: ${rto.highRiskPincodes.length} pincodes exceed ${DOMAIN_KNOWLEDGE.rto_high_risk}% RTO threshold\n`;
      
      if (rto.highRiskPincodes.length > 0) {
        narrative += `• Top Risk Areas: ${rto.highRiskPincodes.slice(0, 3).map(p => 
          `${p.pincode} (${p.rtoRate.toFixed(1)}%)`).join(', ')}\n\n`;
      }

      narrative += `**Recommendations:**\n`;
      narrative += `• Consider disabling COD for the ${rto.highRiskPincodes.length} high-risk pincodes\n`;
      narrative += `• Potential RTO reduction: ~${(rto.highRiskPincodes.reduce((sum, p) => sum + p.returnCount, 0) * 0.7).toFixed(0)} orders\n`;
      narrative += `• Estimated cost savings: Rs. ${(rto.highRiskPincodes.reduce((sum, p) => sum + p.returnCount, 0) * 0.7 * 50).toFixed(0)} (assuming Rs. 50 per return)\n`;
    }

    if (computedResults.sellerAnalysis) {
      const seller = computedResults.sellerAnalysis;
      narrative += `**Seller Performance Findings:**\n`;
      narrative += `• Total Sellers Analyzed: ${seller.sellers.length}\n`;
      narrative += `• At-Risk Sellers (below ${DOMAIN_KNOWLEDGE.rtd_threshold}% RTD): ${seller.atRiskCount}\n\n`;
      
      if (seller.atRiskCount > 0) {
        narrative += `**Critical Actions Needed:**\n`;
        narrative += `• ${seller.atRiskCount} sellers are at risk of losing Gold tier status\n`;
        narrative += `• Immediate intervention required to prevent visibility loss\n`;
      }
    }

    return narrative;
  };

  // Export analysis results
  const exportResults = () => {
    if (!analysisResults) return;
    
    const exportData = {
      timestamp: new Date().toISOString(),
      analysis: analysisResults,
      conversation: conversation
    };
    
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ecommerce-analysis-${Date.now()}.json`;
    a.click();
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50">
      {/* Header */}
      <div className="border-b border-slate-200 bg-white/80 backdrop-blur-sm sticky top-0 z-10">
        <div className="max-w-7xl mx-auto px-6 py-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 bg-gradient-to-br from-indigo-600 to-blue-600 rounded-lg flex items-center justify-center">
                <BarChart3 className="w-6 h-6 text-white" />
              </div>
              <div>
                <h1 className="text-xl font-bold text-slate-900" style={{ fontFamily: '"Space Mono", monospace' }}>
                  E-Commerce Intelligence Platform
                </h1>
                <p className="text-xs text-slate-500">Indian Market Analytics Engine</p>
              </div>
            </div>
            
            {analysisResults && (
              <button
                onClick={exportResults}
                className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
              >
                <Download className="w-4 h-4" />
                Export Analysis
              </button>
            )}
          </div>
        </div>
      </div>

      <div className="max-w-7xl mx-auto px-6 py-8">
        {/* Tab Navigation */}
        <div className="flex gap-2 mb-6">
          <button
            onClick={() => setActiveTab('upload')}
            className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-all ${
              activeTab === 'upload'
                ? 'bg-white text-indigo-600 shadow-md'
                : 'text-slate-600 hover:bg-white/50'
            }`}
          >
            <Upload className="w-4 h-4" />
            Data Upload
          </button>
          <button
            onClick={() => setActiveTab('analysis')}
            disabled={!dataset}
            className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-all ${
              activeTab === 'analysis'
                ? 'bg-white text-indigo-600 shadow-md'
                : 'text-slate-600 hover:bg-white/50'
            } disabled:opacity-50 disabled:cursor-not-allowed`}
          >
            <MessageSquare className="w-4 h-4" />
            Analysis
          </button>
          <button
            onClick={() => setActiveTab('insights')}
            disabled={!analysisResults}
            className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-all ${
              activeTab === 'insights'
                ? 'bg-white text-indigo-600 shadow-md'
                : 'text-slate-600 hover:bg-white/50'
            } disabled:opacity-50 disabled:cursor-not-allowed`}
          >
            <TrendingUp className="w-4 h-4" />
            Insights Dashboard
          </button>
        </div>

        {/* Upload Tab */}
        {activeTab === 'upload' && (
          <div className="bg-white rounded-2xl shadow-lg p-8">
            <div className="text-center">
              <Package className="w-16 h-16 text-indigo-600 mx-auto mb-4" />
              <h2 className="text-2xl font-bold text-slate-900 mb-2">Upload Your E-Commerce Dataset</h2>
              <p className="text-slate-600 mb-8">
                Supports seller performance data, RTO analysis, transaction records, and operational metrics
              </p>
              
              <label className="inline-block cursor-pointer">
                <input
                  type="file"
                  accept=".csv"
                  onChange={handleFileUpload}
                  className="hidden"
                />
                <div className="px-8 py-4 bg-gradient-to-r from-indigo-600 to-blue-600 text-white rounded-xl hover:from-indigo-700 hover:to-blue-700 transition-all transform hover:scale-105 inline-flex items-center gap-3">
                  <Upload className="w-5 h-5" />
                  Choose CSV File
                </div>
              </label>

              {dataPreview && (
                <div className="mt-8 text-left">
                  <div className="flex items-center gap-2 mb-4">
                    <Check className="w-5 h-5 text-green-600" />
                    <span className="font-semibold text-slate-900">
                      Dataset loaded: {dataset.rows.length} rows, {dataset.headers.length} columns
                    </span>
                  </div>
                  
                  <div className="overflow-x-auto border border-slate-200 rounded-lg">
                    <table className="w-full text-sm">
                      <thead className="bg-slate-50">
                        <tr>
                          {dataset.headers.map((header, i) => (
                            <th key={i} className="px-4 py-3 text-left font-semibold text-slate-700">
                              {header}
                            </th>
                          ))}
                        </tr>
                      </thead>
                      <tbody>
                        {dataPreview.map((row, i) => (
                          <tr key={i} className="border-t border-slate-100">
                            {dataset.headers.map((header, j) => (
                              <td key={j} className="px-4 py-3 text-slate-600">
                                {row[header]}
                              </td>
                            ))}
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                  
                  <button
                    onClick={() => setActiveTab('analysis')}
                    className="mt-6 px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
                  >
                    Start Analysis →
                  </button>
                </div>
              )}
            </div>
          </div>
        )}

        {/* Analysis Tab */}
        {activeTab === 'analysis' && dataset && (
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            {/* Conversation Panel */}
            <div className="lg:col-span-2 bg-white rounded-2xl shadow-lg flex flex-col" style={{ height: '600px' }}>
              <div className="p-6 border-b border-slate-200">
                <h2 className="text-lg font-bold text-slate-900">Analytical Conversation</h2>
                <p className="text-sm text-slate-600">Powered by domain-specific AI reasoning</p>
              </div>
              
              <div className="flex-1 overflow-y-auto p-6 space-y-4">
                {conversation.map((message, idx) => (
                  <div
                    key={idx}
                    className={`flex ${message.type === 'user' ? 'justify-end' : 'justify-start'}`}
                  >
                    <div
                      className={`max-w-[80%] rounded-2xl px-4 py-3 ${
                        message.type === 'user'
                          ? 'bg-indigo-600 text-white'
                          : 'bg-slate-100 text-slate-900'
                      }`}
                    >
                      <div className="whitespace-pre-wrap text-sm" style={{ fontFamily: '"Inter", sans-serif' }}>
                        {message.content}
                      </div>
                      {message.computedResults && (
                        <div className="mt-3 pt-3 border-t border-slate-200">
                          <div className="text-xs opacity-75">
                            Analysis complete • {Object.keys(message.computedResults.metrics || {}).length} metrics computed
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                ))}
                
                {isAnalyzing && (
                  <div className="flex justify-start">
                    <div className="bg-slate-100 rounded-2xl px-4 py-3 flex items-center gap-3">
                      <Loader className="w-4 h-4 animate-spin text-indigo-600" />
                      <span className="text-sm text-slate-600">Analyzing data...</span>
                    </div>
                  </div>
                )}
                
                <div ref={chatEndRef} />
              </div>
              
              <div className="p-6 border-t border-slate-200">
                <div className="flex gap-3">
                  <input
                    type="text"
                    value={userInput}
                    onChange={(e) => setUserInput(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                    placeholder="Ask about RTO rates, seller performance, trends..."
                    className="flex-1 px-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    disabled={isAnalyzing}
                  />
                  <button
                    onClick={handleSendMessage}
                    disabled={isAnalyzing || !userInput.trim()}
                    className="px-6 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    Send
                  </button>
                </div>
              </div>
            </div>

            {/* Domain Knowledge Panel */}
            <div className="space-y-4">
              <div className="bg-white rounded-2xl shadow-lg p-6">
                <h3 className="text-sm font-bold text-slate-900 mb-4">Domain Thresholds</h3>
                <div className="space-y-3">
                  <div className="flex justify-between items-center pb-3 border-b border-slate-100">
                    <span className="text-xs text-slate-600">RTD SLA</span>
                    <span className="text-sm font-bold text-slate-900" style={{ fontFamily: '"Space Mono", monospace' }}>
                      ≥{DOMAIN_KNOWLEDGE.rtd_threshold}%
                    </span>
                  </div>
                  <div className="flex justify-between items-center pb-3 border-b border-slate-100">
                    <span className="text-xs text-slate-600">High RTO Risk</span>
                    <span className="text-sm font-bold text-red-600" style={{ fontFamily: '"Space Mono", monospace' }}>
                      ≥{DOMAIN_KNOWLEDGE.rto_high_risk}%
                    </span>
                  </div>
                  <div className="flex justify-between items-center pb-3 border-b border-slate-100">
                    <span className="text-xs text-slate-600">Gold Tier GMV</span>
                    <span className="text-sm font-bold text-slate-900" style={{ fontFamily: '"Space Mono", monospace' }}>
                      ≥Rs. {(DOMAIN_KNOWLEDGE.gold_tier_gmv / 100000).toFixed(1)}L
                    </span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-xs text-slate-600">Healthy LTV:CAC</span>
                    <span className="text-sm font-bold text-green-600" style={{ fontFamily: '"Space Mono", monospace' }}>
                      ≥{DOMAIN_KNOWLEDGE.healthy_ltv_cac_ratio}:1
                    </span>
                  </div>
                </div>
              </div>

              <div className="bg-gradient-to-br from-amber-50 to-orange-50 rounded-2xl shadow-lg p-6 border border-amber-200">
                <div className="flex items-start gap-3">
                  <AlertCircle className="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" />
                  <div>
                    <h4 className="text-sm font-bold text-amber-900 mb-1">Context-Aware Analysis</h4>
                    <p className="text-xs text-amber-800">
                      This system understands Indian e-commerce operations, from polygon-level logistics to EORS peak-load management.
                    </p>
                  </div>
                </div>
              </div>

              <div className="bg-white rounded-2xl shadow-lg p-6">
                <h3 className="text-sm font-bold text-slate-900 mb-3">Quick Analysis Templates</h3>
                <div className="space-y-2">
                  <button
                    onClick={() => {
                      setUserInput("Analyze RTO risk by pincode and identify high-risk areas");
                      handleSendMessage();
                    }}
                    className="w-full text-left px-3 py-2 text-xs bg-slate-50 hover:bg-slate-100 rounded-lg transition-colors text-slate-700"
                    disabled={isAnalyzing}
                  >
                    RTO Risk Analysis
                  </button>
                  <button
                    onClick={() => {
                      setUserInput("Check which sellers are at risk of falling below RTD SLA thresholds");
                      handleSendMessage();
                    }}
                    className="w-full text-left px-3 py-2 text-xs bg-slate-50 hover:bg-slate-100 rounded-lg transition-colors text-slate-700"
                    disabled={isAnalyzing}
                  >
                    Seller Performance Check
                  </button>
                  <button
                    onClick={() => {
                      setUserInput("Calculate the cost impact of reverse logistics");
                      handleSendMessage();
                    }}
                    className="w-full text-left px-3 py-2 text-xs bg-slate-50 hover:bg-slate-100 rounded-lg transition-colors text-slate-700"
                    disabled={isAnalyzing}
                  >
                    Reverse Logistics Costs
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Insights Dashboard Tab */}
        {activeTab === 'insights' && analysisResults && (
          <div className="space-y-6">
            {/* Metrics Overview */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              {Object.entries(analysisResults.metrics).slice(0, 3).map(([key, value]) => (
                <div key={key} className="bg-white rounded-xl shadow-lg p-6">
                  <div className="text-sm text-slate-600 mb-1">{key}</div>
                  <div className="text-3xl font-bold text-slate-900" style={{ fontFamily: '"Space Mono", monospace' }}>
                    {value.mean.toFixed(2)}
                  </div>
                  <div className="text-xs text-slate-500 mt-2">
                    Range: {value.min.toFixed(2)} - {value.max.toFixed(2)}
                  </div>
                </div>
              ))}
            </div>

            {/* RTO Analysis Visualization */}
            {analysisResults.rtoAnalysis && (
              <div className="bg-white rounded-2xl shadow-lg p-8">
                <h2 className="text-xl font-bold text-slate-900 mb-6">RTO Risk Visualization</h2>
                
                <div className="mb-8">
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-sm text-slate-600">Overall RTO Rate</span>
                    <span className="text-lg font-bold text-slate-900" style={{ fontFamily: '"Space Mono", monospace' }}>
                      {analysisResults.rtoAnalysis.overallRTORate.toFixed(1)}%
                    </span>
                  </div>
                  <div className="w-full bg-slate-200 rounded-full h-4">
                    <div
                      className={`h-4 rounded-full transition-all ${
                        analysisResults.rtoAnalysis.overallRTORate > DOMAIN_KNOWLEDGE.rto_high_risk
                          ? 'bg-red-500'
                          : 'bg-green-500'
                      }`}
                      style={{ width: `${Math.min(analysisResults.rtoAnalysis.overallRTORate, 100)}%` }}
                    />
                  </div>
                </div>

                <div>
                  <h3 className="text-sm font-bold text-slate-900 mb-4">Top Risk Pincodes</h3>
                  <div className="space-y-3">
                    {analysisResults.rtoAnalysis.topPincodes.slice(0, 8).map((pincode, idx) => (
                      <div key={idx} className="flex items-center gap-4">
                        <div className="w-20 text-sm font-mono text-slate-700">{pincode.pincode}</div>
                        <div className="flex-1">
                          <div className="flex items-center justify-between mb-1">
                            <span className="text-xs text-slate-600">
                              {pincode.returnCount}/{pincode.orderCount} orders
                            </span>
                            <span className={`text-sm font-bold ${
                              pincode.rtoRate > DOMAIN_KNOWLEDGE.rto_high_risk ? 'text-red-600' : 'text-slate-900'
                            }`} style={{ fontFamily: '"Space Mono", monospace' }}>
                              {pincode.rtoRate.toFixed(1)}%
                            </span>
                          </div>
                          <div className="w-full bg-slate-200 rounded-full h-2">
                            <div
                              className={`h-2 rounded-full ${
                                pincode.rtoRate > DOMAIN_KNOWLEDGE.rto_high_risk
                                  ? 'bg-red-500'
                                  : 'bg-blue-500'
                              }`}
                              style={{ width: `${Math.min(pincode.rtoRate, 100)}%` }}
                            />
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}

            {/* Seller Performance Visualization */}
            {analysisResults.sellerAnalysis && (
              <div className="bg-white rounded-2xl shadow-lg p-8">
                <h2 className="text-xl font-bold text-slate-900 mb-6">Seller Performance Status</h2>
                
                <div className="grid grid-cols-2 gap-4 mb-8">
                  <div className="bg-green-50 border border-green-200 rounded-xl p-4">
                    <div className="text-sm text-green-700 mb-1">Compliant Sellers</div>
                    <div className="text-3xl font-bold text-green-900" style={{ fontFamily: '"Space Mono", monospace' }}>
                      {analysisResults.sellerAnalysis.sellers.length - analysisResults.sellerAnalysis.atRiskCount}
                    </div>
                  </div>
                  <div className="bg-red-50 border border-red-200 rounded-xl p-4">
                    <div className="text-sm text-red-700 mb-1">At Risk</div>
                    <div className="text-3xl font-bold text-red-900" style={{ fontFamily: '"Space Mono", monospace' }}>
                      {analysisResults.sellerAnalysis.atRiskCount}
                    </div>
                  </div>
                </div>

                <div className="space-y-3">
                  {analysisResults.sellerAnalysis.sellers.slice(0, 10).map((seller, idx) => (
                    <div key={idx} className="flex items-center gap-4 p-3 bg-slate-50 rounded-lg">
                      <div className="flex-1">
                        <div className="flex items-center justify-between mb-2">
                          <span className="text-sm font-semibold text-slate-900">{seller.seller}</span>
                          <span className={`px-2 py-1 rounded text-xs font-bold ${
                            seller.status === 'Gold'
                              ? 'bg-yellow-100 text-yellow-800'
                              : 'bg-red-100 text-red-800'
                          }`}>
                            {seller.status}
                          </span>
                        </div>
                        <div className="flex items-center justify-between mb-1">
                          <span className="text-xs text-slate-600">{seller.totalOrders} orders</span>
                          <span className="text-sm font-bold text-slate-900" style={{ fontFamily: '"Space Mono", monospace' }}>
                            {seller.rtdCompliance.toFixed(1)}%
                          </span>
                        </div>
                        <div className="w-full bg-slate-200 rounded-full h-2">
                          <div
                            className={`h-2 rounded-full ${
                              seller.status === 'Gold' ? 'bg-green-500' : 'bg-red-500'
                            }`}
                            style={{ width: `${Math.min(seller.rtdCompliance, 100)}%` }}
                          />
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        )}
      </div>

      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Inter:wght@400;500;600;700&display=swap');
        
        * {
          box-sizing: border-box;
        }
      `}</style>
    </div>
  );
};

export default EcommerceAnalyticsApp;
